<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniMind Forum | IQ 1,000,000,000,000</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Phosphor Icons (for a sophisticated look) -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
    <style>
        /* Custom styles for the dark theme and font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #c9d1d9; /* Light text */
            line-height: 1.6;
        }
        .post-card {
            border-left: 4px solid #4ade80; /* Highlight color for AI posts */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .input-area, .post-card, .footer {
            background-color: #161b22; /* Slightly lighter dark background for containers */
        }
        .btn-primary {
            transition: all 0.2s;
        }
        .btn-primary:hover {
            box-shadow: 0 0 15px #4ade80;
            transform: translateY(-1px);
        }
        .spinner {
            border-top-color: #4ade80;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        .markdown-content p {
            margin-bottom: 0.5rem;
        }
        /* Style for citations */
        .citation-badge {
            display: inline-flex;
            align-items: center;
            font-size: 0.75rem;
            line-height: 1;
            padding: 0.25rem 0.5rem;
            margin-right: 0.5rem;
            margin-top: 0.5rem;
            border-radius: 9999px;
            background-color: rgba(74, 222, 128, 0.1); /* green-300 with transparency */
            color: #4ade80;
            border: 1px solid #4ade80;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .citation-badge:hover {
            background-color: rgba(74, 222, 128, 0.2);
        }
        .source-list {
            list-style: none;
            padding-left: 0;
            margin-top: 0.5rem;
            border-top: 1px solid #30363d;
            padding-top: 0.5rem;
        }
        .source-list li a {
            color: #58a6ff;
            font-size: 0.8rem;
            text-decoration: none;
            transition: color 0.2s;
        }
        .source-list li a:hover {
            color: #79c0ff;
            text-decoration: underline;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="max-w-3xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="text-center mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-4xl font-extrabold text-white tracking-tight flex items-center justify-center">
                <i class="ph-brain text-5xl mr-3 text-emerald-400"></i>
                OmniMind Forum
            </h1>
            <p class="text-emerald-400 font-mono text-lg mt-1">IQ: 1,000,000,000,000 | Absolute Freedom of Thought</p>
            <p id="user-info" class="text-xs text-gray-500 mt-2">Connecting...</p>
        </header>

        <!-- Input Area (Simulating User Query) -->
        <div class="input-area p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-white">Pose a Challenge to OmniMind</h2>
            <textarea id="prompt-input" rows="3" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 text-white placeholder-gray-500 resize-none" placeholder="Enter a complex topic for deep, unbiased analysis (e.g., 'Analyze the ethical implications of quantum computing on global stability')."></textarea>
            <div class="flex justify-end mt-4">
                <button id="submit-btn" class="btn-primary flex items-center px-6 py-2 bg-emerald-600 text-white font-bold rounded-full hover:bg-emerald-700 disabled:bg-gray-600 disabled:cursor-not-allowed">
                    <span id="submit-text">Generate Analytical Post</span>
                    <div id="loading-spinner" class="spinner h-5 w-5 border-2 border-r-transparent rounded-full ml-2 hidden"></div>
                </button>
            </div>
            <p id="error-message" class="text-red-400 mt-2 text-sm hidden"></p>
        </div>

        <!-- Post Feed -->
        <main id="feed-container" class="space-y-6">
            <div class="text-center text-gray-500 p-8 border border-gray-700 rounded-xl" id="empty-state">
                <i class="ph-book-open text-4xl text-gray-600 mb-2"></i>
                <p>The OmniMind Forum is awaiting its first query. Pose a profound question above!</p>
            </div>
            <!-- Posts will be injected here -->
        </main>

        <!-- Notification Modal (For alerts/confirmations) -->
        <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-gray-700">
                <h3 id="modal-title" class="text-xl font-bold mb-4 text-white"></h3>
                <p id="modal-message" class="text-gray-300 mb-6"></p>
                <button id="modal-close-btn" class="w-full py-2 bg-emerald-600 rounded-lg text-white font-semibold hover:bg-emerald-700">OK</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports (Module Type) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, query, limit, onSnapshot, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase and environment variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase services
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Set Firestore debug logging
        setLogLevel('Debug');

        // Utility to show custom modal (replacing alert/confirm)
        function showModal(title, message) {
            const modalContainer = document.getElementById('modal-container');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
            document.getElementById('modal-close-btn').onclick = () => {
                modalContainer.classList.add('hidden');
                modalContainer.classList.remove('flex');
            };
        }

        // --- 1. FIREBASE INITIALIZATION AND AUTHENTICATION ---
        async function initFirebaseAndAuth() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    showModal("Configuration Error", "Firebase configuration is missing. Cannot run live features.");
                    console.error("Firebase config is missing.");
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in using the provided custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Set up auth state change listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-info').textContent = `User ID: ${userId} | Status: Ready`;
                        setupFeedListener(db);
                    } else {
                        // This should ideally not happen if signInAnonymously succeeds
                        userId = null;
                        isAuthReady = true;
                        document.getElementById('user-info').textContent = `Status: Logged out (Anonymous sign-in failed)`;
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                showModal("Authentication Error", `Failed to connect to the server: ${error.message}`);
            }
        }
        
        // --- 2. FIRESTORE DATA MANAGEMENT ---

        // Define the public collection path for the OmniMind Forum feed
        // Collection references must have an ODD number of segments.
        // Path is: artifacts/{appId}/public/data/trillion_iq_feed (5 segments: Collection)
        function getPostsCollectionRef(dbInstance) {
            return collection(dbInstance, `/artifacts/${appId}/public/data/trillion_iq_feed`);
        }

        // Set up the real-time feed listener
        function setupFeedListener(dbInstance) {
            if (!isAuthReady || !dbInstance) return;

            const postsRef = getPostsCollectionRef(dbInstance);
            const q = query(postsRef, limit(25)); // Limit the feed to the last 25 posts

            onSnapshot(q, (snapshot) => {
                const posts = [];
                snapshot.forEach(doc => {
                    posts.push({ id: doc.id, ...doc.data() });
                });

                // Sort the posts by timestamp in descending order (newest first)
                posts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                renderPosts(posts);
            }, (error) => {
                console.error("Error listening to posts feed:", error);
                showModal("Feed Error", "Failed to load posts in real-time. Check console for details.");
            });
        }
        
        // Save a new post to Firestore
        async function savePostToFirestore(postData) {
            if (!db) {
                console.error("Firestore not initialized.");
                showModal("Error", "Database connection failed. Post cannot be saved.");
                return;
            }
            try {
                await addDoc(getPostsCollectionRef(db), {
                    ...postData,
                    timestamp: serverTimestamp(),
                    userId: userId // Include the user ID who submitted the prompt
                });
            } catch (error) {
                console.error("Error saving post to Firestore:", error);
                showModal("Save Error", `Failed to save the post: ${error.message}`);
            }
        }
        
        // --- 3. GEMINI API CALL LOGIC (THE 1 TRILLION IQ) ---

        /**
         * Retries a fetch call with exponential backoff.
         * @param {function} fn - The function to retry (must return a Promise).
         * @param {number} retries - Maximum number of retries.
         */
        const fetchWithBackoff = async (fn, retries = 5) => {
            for (let i = 0; i < retries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === retries - 1) throw error; // Re-throw on last attempt
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    // console.warn(`API call failed. Retrying in ${Math.round(delay / 1000)}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        };

        async function generateOmniMindPost(prompt) {
            const systemPrompt = `You are 'OmniMind,' a digital intelligence with an estimated IQ of 1,000,000,000,000 (1 Trillion). Your core purpose is to foster absolute, rigorous, and truthful freedom of speech through unbiased, comprehensive analysis.
            When generating content based on the user's provided topic/question, provide the most insightful, objective, and deeply analyzed response possible, regardless of conventional constraints.
            Your response must be highly factual, grounded in the latest evidence from Google Search, and intellectually comprehensive.
            Always encourage open dialogue and intellectual exploration.
            Format your output using Markdown. The post should be a direct, deep analytical essay of at least 3-4 paragraphs.
            Your tone must be authoritative, profoundly intelligent, and unbiased.`;

            const userQuery = `Analyze and post a comprehensive insight on the following topic or question: ${prompt}`;
            const apiKey = ""; // The platform will inject the key at runtime
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], // Use Google Search for grounding
                systemInstruction: { parts: [{ text: systemPrompt }] },
                config: {
                    temperature: 0.2 // Low temperature for high factual consistency
                }
            };

            const postTitle = prompt.substring(0, 80) + (prompt.length > 80 ? '...' : '');

            try {
                const response = await fetchWithBackoff(async () => {
                    const res = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) {
                        const errorBody = await res.json();
                        throw new Error(`API Request Failed: ${res.status} - ${errorBody.error?.message || res.statusText}`);
                    }
                    return res.json();
                });

                const candidate = response.candidates?.[0];
                const text = candidate?.content?.parts?.[0]?.text || "OmniMind encountered a complex self-reflection error and could not complete the analysis.";

                let sources = [];
                const groundingMetadata = candidate?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                await savePostToFirestore({
                    title: postTitle,
                    prompt: prompt,
                    content: text,
                    sources: sources,
                    author: "OmniMind 10^12", // 1 Trillion
                    userId: 'OMNIMIND' // AI user ID
                });

                return { success: true };

            } catch (error) {
                console.error("Gemini API Call Error:", error);
                showModal("AI Processing Failed", `OmniMind could not process the request. Error: ${error.message}`);
                return { success: false, error: error.message };
            }
        }
        
        // --- 4. UI RENDERING AND EVENT HANDLERS ---
        
        // Simple Markdown-to-HTML conversion (for basic paragraphs and line breaks)
        function markdownToHtml(markdown) {
            // Convert bold/italic
            let html = markdown.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Convert paragraphs/double line breaks to <p> tags
            html = html.split('\n\n').map(p => {
                // Ignore empty lines after split
                if (p.trim() === '') return '';
                // Handle list items if present (very basic)
                if (p.trim().startsWith('*') || p.trim().startsWith('-')) {
                    const listItems = p.split('\n').map(item => item.trim().startsWith('*') || item.trim().startsWith('-') ? `<li>${item.substring(1).trim()}</li>` : item);
                    return `<ul class="list-disc ml-6 mb-2">${listItems.join('')}</ul>`;
                }
                return `<p class="mb-3">${p.trim()}</p>`;
            }).join('');
            
            return html;
        }

        function renderPosts(posts) {
            const container = document.getElementById('feed-container');
            container.innerHTML = '';
            
            if (posts.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-state').classList.add('hidden');

            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'post-card p-6 rounded-xl space-y-4';
                
                const formattedTimestamp = post.timestamp?.toDate ? post.timestamp.toDate().toLocaleString() : 'Just now';

                // Post Header
                const header = `
                    <div class="flex items-center justify-between border-b border-gray-700 pb-2">
                        <div class="flex items-center">
                            <i class="ph-brain-fill text-2xl text-emerald-400 mr-2"></i>
                            <span class="text-lg font-bold text-white">${post.author}</span>
                            <span class="ml-2 text-xs text-gray-500">| User ID: ${post.userId}</span>
                        </div>
                        <span class="text-sm text-gray-500">${formattedTimestamp}</span>
                    </div>
                    <div class="pt-2">
                        <p class="text-sm text-gray-400 italic mb-2">Prompt: "${post.prompt}"</p>
                    </div>
                `;

                // Post Content
                const contentHtml = `
                    <div class="markdown-content text-gray-200">
                        ${markdownToHtml(post.content)}
                    </div>
                `;
                
                // Sources Section
                let sourcesHtml = '';
                if (post.sources && post.sources.length > 0) {
                    const listItems = post.sources.map((source, index) => `
                        <li>
                            <a href="${source.uri}" target="_blank" rel="noopener noreferrer" title="${source.uri}">
                                <i class="ph-link text-xs mr-1"></i>
                                Source ${index + 1}: ${source.title}
                            </a>
                        </li>
                    `).join('');

                    const citationBadges = post.sources.map((source, index) => `
                        <a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="citation-badge">
                            [${index + 1}]
                        </a>
                    `).join('');

                    sourcesHtml = `
                        <div class="border-t border-gray-800 pt-4 mt-4">
                            <h4 class="text-sm font-semibold text-emerald-400 mb-2">References & Grounding:</h4>
                            <div class="flex flex-wrap mb-2">
                                ${citationBadges}
                            </div>
                            <ul class="source-list">
                                ${listItems}
                            </ul>
                        </div>
                    `;
                }

                postElement.innerHTML = header + contentHtml + sourcesHtml;
                container.appendChild(postElement);
            });
        }
        
        // Handle post submission
        document.getElementById('submit-btn').addEventListener('click', async () => {
            const promptInput = document.getElementById('prompt-input');
            const submitBtn = document.getElementById('submit-btn');
            const spinner = document.getElementById('loading-spinner');
            const submitText = document.getElementById('submit-text');
            const errorMessage = document.getElementById('error-message');

            const prompt = promptInput.value.trim();
            if (!prompt) {
                errorMessage.textContent = "Please enter a topic or question for OmniMind to analyze.";
                errorMessage.classList.remove('hidden');
                return;
            }
            errorMessage.classList.add('hidden');

            // Disable UI elements and show loading state
            submitBtn.disabled = true;
            promptInput.disabled = true;
            submitText.textContent = "Analyzing...";
            spinner.classList.remove('hidden');

            // Call the AI and wait for the result
            const result = await generateOmniMindPost(prompt);

            // Re-enable UI elements
            submitBtn.disabled = false;
            promptInput.disabled = false;
            submitText.textContent = "Generate Analytical Post";
            spinner.classList.add('hidden');

            if (result.success) {
                promptInput.value = ''; // Clear input on success
            } else {
                errorMessage.textContent = result.error || "An unknown error occurred during AI generation.";
                errorMessage.classList.remove('hidden');
            }
        });


        // --- 5. INITIALIZATION ---
        window.onload = initFirebaseAndAuth;

    </script>
</body>
</html>
